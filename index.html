<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nettverksendringsdetektor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #fff;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .status-item {
            background: #16213e;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }

        .status-item.changed {
            background: #e94560;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .status-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1rem;
            font-weight: 600;
            color: #4ecca3;
        }

        .status-item.changed .status-value {
            color: #fff;
        }

        .logs-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .log-section {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
        }

        .log-section.all-reports {
            border: 2px solid #3498db;
        }

        .log-section.changes-only {
            border: 2px solid #e94560;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .log-header h2 {
            font-size: 1.1rem;
        }

        .log-container {
            background: #0f0f23;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
            border-left: 3px solid #4ecca3;
            animation: slideIn 0.3s ease-out;
        }

        .log-entry.change {
            border-left-color: #e94560;
            background: rgba(233, 69, 96, 0.2);
        }

        .log-entry.change-status {
            border-left-color: #e94560;
            background: rgba(233, 69, 96, 0.3);
        }

        .log-entry.change-ip {
            border-left-color: #e94560;
            background: rgba(233, 69, 96, 0.3);
        }

        .log-entry.change-type {
            border-left-color: #e94560;
            background: rgba(233, 69, 96, 0.3);
        }

        .log-entry.info {
            border-left-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .log-entry.info .log-type {
            color: #4ecca3;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-time {
            color: #888;
            margin-right: 10px;
        }

        .log-type {
            font-weight: 600;
            margin-right: 10px;
        }

        .log-entry.change .log-type,
        .log-entry.change-status .log-type,
        .log-entry.change-ip .log-type,
        .log-entry.change-type .log-type {
            color: #e94560;
        }

        .log-entry.info .log-type {
            color: #3498db;
        }

        .check-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ecca3;
            margin-left: 10px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Nettverksendringsdetektor <span class="check-indicator"></span></h1>
            <p>Rapport hvert 5. sekund om nettverksstatus</p>
        </header>

        <div class="status-bar">
            <div class="status-item" id="status-online">
                <div class="status-label">Status</div>
                <div class="status-value" id="online-status">Sjekker...</div>
            </div>
            <div class="status-item" id="status-ip">
                <div class="status-label">IP Adresse</div>
                <div class="status-value" id="ip-address">Sjekker...</div>
            </div>
            <div class="status-item" id="status-type">
                <div class="status-label">Tilkobling</div>
                <div class="status-value" id="connection-type">Sjekker...</div>
            </div>
            <div class="status-item" id="status-changes">
                <div class="status-label">Endringer</div>
                <div class="status-value" id="change-count">0</div>
            </div>
        </div>

        <div class="logs-wrapper">
            <div class="log-section all-reports">
                <div class="log-header">
                    <h2>Alle Rapporter</h2>
                </div>
                <div class="log-container" id="all-log-container">
                    <div class="log-entry info">
                        <span class="log-time">--:--:--</span>
                        <span class="log-type">INFO</span>
                        <span>Starter overvåking...</span>
                    </div>
                </div>
            </div>

            <div class="log-section changes-only">
                <div class="log-header">
                    <h2>Kun Endringer</h2>
                </div>
                <div class="log-container" id="changes-log-container">
                    <div class="log-entry info">
                        <span class="log-time">--:--:--</span>
                        <span class="log-type">INFO</span>
                        <span>Venter på endringer...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let initialState = {
            online: null,
            ip: null,
            type: null,
            initialized: false
        };

        let changeCount = 0;
        let currentState = {};
        let hasRecentChanges = false;  // Holder styr på om det har vært endringer
        let appStartTime = Date.now();
        const GRACE_PERIOD = 15000; // 15 sekunder

        function shouldLogChange() {
            return (Date.now() - appStartTime) >= GRACE_PERIOD;
        }

        async function getIP() {
            if (!navigator.onLine) {
                console.log('getIP: Offline, returnerer Offline (ingen IP)');
                return 'Offline (ingen IP)';
            }
            try {
                console.log('getIP: Henter IP fra ipify...');
                // Legg til timeout på 3 sekunder
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch('https://api.ipify.org?format=json', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                console.log('getIP: Fikk IP:', data.ip);
                return data.ip;
            } catch (err) {
                console.log('getIP: Feil:', err.message);
                // Hvis vi ikke kan hente IP, er vi sannsynligvis offline
                return 'Offline (ingen IP)';
            }
        }

        function getConnectionType() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (!connection) return 'Ukjent';
            return connection.effectiveType || connection.type || 'Ukjent';
        }

        function getOnlineStatus() {
            // Bruk currentState.online hvis den er satt, ellers sjekk navigator
            if (currentState && typeof currentState.online !== 'undefined') {
                return currentState.online ? 'Online' : 'Offline';
            }
            return navigator.onLine ? 'Online' : 'Offline';
        }

        function formatTime() {
            const now = new Date();
            return now.toLocaleTimeString('no-NO', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function addToAllLog(message, type = 'info') {
            const container = document.getElementById('all-log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const displayType = type === 'change' ? 'ENDRET' : 'RAPPORT';
            entry.innerHTML = `
                <span class="log-time">${formatTime()}</span>
                <span class="log-type">${displayType}</span>
                <span>${message}</span>
            `;
            container.insertBefore(entry, container.firstChild);
        }

        function addToChangesLog(message, changeClass = 'change') {
            const container = document.getElementById('changes-log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${changeClass}`;
            entry.innerHTML = `
                <span class="log-time">${formatTime()}</span>
                <span class="log-type">ENDRET</span>
                <span>${message}</span>
            `;
            container.insertBefore(entry, container.firstChild);
        }

        function updateStatus(elementId, value, isChanged = false) {
            const element = document.getElementById(elementId);
            element.textContent = value;
            const parent = element.closest('.status-item');
            if (isChanged) {
                parent.classList.add('changed');
                setTimeout(() => parent.classList.remove('changed'), 2000);
            }
        }

        let reportCounter = 0;

        function sendStatusReport() {
            reportCounter++;
            const report = `RAPPORT #${reportCounter}: IP=${currentState.ip}, ${getOnlineStatus()}, ${currentState.type}`;
            
            // Hvis det har vært endringer, vis rapport med rød bakgrunn
            if (hasRecentChanges) {
                addToAllLog(report, 'change');
                hasRecentChanges = false;  // Nullstill etter rapport
            } else {
                addToAllLog(report, 'info');
            }
        }

        async function checkForChanges() {
            // Hent ny IP hvis vi er online
            let newIP = currentState.ip;
            if (navigator.onLine && currentState.ip === 'Offline (ingen IP)') {
                newIP = await getIP();
            }
            
            // Bestem online-status: hvis IP er "Offline (ingen IP)", er vi offline
            let onlineStatus = navigator.onLine;
            if (newIP === 'Offline (ingen IP)') {
                onlineStatus = false;
            }
            
            const newState = {
                online: onlineStatus,
                ip: newIP,
                type: getConnectionType()
            };

            if (!initialState.initialized) {
                return;
            }

            let hasChange = false;
            const statusChanged = newState.online !== currentState.online;
            const ipChanged = newState.ip !== currentState.ip;
            const typeChanged = newState.type !== currentState.type;

            // Kombiner status og IP endring til én melding
            if (statusChanged && ipChanged) {
                const status = newState.online ? 'Online' : 'Offline';
                const prevStatus = currentState.online ? 'Online' : 'Offline';
                const message = `${prevStatus} → ${status} (IP: ${newState.ip})`;
                addToAllLog(`ENDRET: ${message}`, 'change-status');
                if (shouldLogChange()) {
                    addToChangesLog(message, 'change-status');
                }
                updateStatus('online-status', status, true);
                updateStatus('ip-address', newState.ip, true);
                changeCount++;
                hasChange = true;
            } else if (statusChanged) {
                const status = newState.online ? 'Online' : 'Offline';
                const prevStatus = currentState.online ? 'Online' : 'Offline';
                const message = `Status: ${prevStatus} → ${status}`;
                addToAllLog(`ENDRET: ${message}`, 'change-status');
                if (shouldLogChange()) {
                    addToChangesLog(message, 'change-status');
                }
                updateStatus('online-status', status, true);
                changeCount++;
                hasChange = true;
            } else if (ipChanged) {
                const message = `IP: ${currentState.ip} → ${newState.ip}`;
                addToAllLog(`ENDRET: ${message}`, 'change-ip');
                if (shouldLogChange()) {
                    addToChangesLog(message, 'change-ip');
                }
                updateStatus('ip-address', newState.ip, true);
                changeCount++;
                hasChange = true;
            }

            if (typeChanged) {
                const message = `Tilkoblingstype: ${currentState.type} → ${newState.type}`;
                addToAllLog(`ENDRET: ${message}`, 'change-type');
                if (shouldLogChange()) {
                    addToChangesLog(message, 'change-type');
                }
                updateStatus('connection-type', newState.type, true);
                changeCount++;
                hasChange = true;
            }

            if (hasChange) {
                updateStatus('change-count', changeCount);
                if (shouldLogChange()) {
                    hasRecentChanges = true;
                }
            }

            currentState = newState;
        }

        async function initialize() {
            console.log('Initialize starter, online status:', navigator.onLine);
            
            // Sett initial state - IKKE bruk await hvis offline
            currentState.online = navigator.onLine;
            currentState.type = getConnectionType();
            
            // Hent IP hvis online, ellers sett offline-verdi umiddelbart
            if (!navigator.onLine) {
                console.log('Offline ved start, setter IP til Offline (ingen IP)');
                currentState.ip = 'Offline (ingen IP)';
            } else {
                console.log('Online ved start, henter IP...');
                currentState.ip = await getIP();
            }

            initialState = { ...currentState, initialized: true };
            
            console.log('Initial state satt:', currentState);

            // Oppdater UI
            updateStatus('ip-address', currentState.ip);
            updateStatus('online-status', getOnlineStatus());
            updateStatus('connection-type', currentState.type);

            // Legg til start-melding i begge logger
            const startMessage = `START: IP=${currentState.ip}, Status=${getOnlineStatus()}, Type=${currentState.type}`;
            console.log('Starter app:', startMessage);
            
            // Fjern "Starter overvåking..." meldingen først
            try {
                const allContainer = document.getElementById('all-log-container');
                const changesContainer = document.getElementById('changes-log-container');
                if (allContainer) allContainer.innerHTML = '';
                if (changesContainer) changesContainer.innerHTML = '';
            } catch (e) {
                console.error('Kunne ikke tømme containere:', e);
            }
            
            addToAllLog(startMessage, 'info');
            // Legg IKKE til i endringsloggen - dette er ikke en endring
            
            // Send første rapport
            sendStatusReport();
            console.log('Initialize fullført');

            setInterval(async () => {
                const previousIP = currentState.ip;
                const previousOnline = currentState.online;
                
                // Hent IP uansett - getIP håndterer offline-sjekk
                const newIP = await getIP();
                
                // Hvis vi fikk "Offline (ingen IP)", sett online til false
                if (newIP === 'Offline (ingen IP)') {
                    currentState.ip = 'Offline (ingen IP)';
                    currentState.online = false;
                } else {
                    currentState.ip = newIP;
                    currentState.online = true;
                }
                
                // Oppdater status-bar uansett (for å vise Offline når offline)
                updateStatus('ip-address', currentState.ip, currentState.online !== previousOnline);
                updateStatus('online-status', getOnlineStatus(), currentState.online !== previousOnline);
                
                // Sjekk om online-status OG IP endret seg samtidig
                const statusChanged = currentState.online !== previousOnline && initialState.initialized;
                const ipChanged = currentState.ip !== previousIP && initialState.initialized;
                
                if (statusChanged && ipChanged) {
                    // Begge endret seg - lag én kombinert melding
                    const status = currentState.online ? 'Online' : 'Offline';
                    const prevStatus = previousOnline ? 'Online' : 'Offline';
                    const message = `${prevStatus} → ${status} (IP: ${currentState.ip})`;
                    addToAllLog(`ENDRET: ${message}`, 'change-status');
                    if (shouldLogChange()) {
                        addToChangesLog(message, 'change-status');
                    }
                    changeCount++;
                    updateStatus('change-count', changeCount);
                    if (shouldLogChange()) {
                        hasRecentChanges = true;
                    }
                } else if (statusChanged) {
                    // Kun status endret
                    const status = currentState.online ? 'Online' : 'Offline';
                    const prevStatus = previousOnline ? 'Online' : 'Offline';
                    const message = `Status: ${prevStatus} → ${status}`;
                    addToAllLog(`ENDRET: ${message}`, 'change-status');
                    if (shouldLogChange()) {
                        addToChangesLog(message, 'change-status');
                    }
                    changeCount++;
                    updateStatus('change-count', changeCount);
                    if (shouldLogChange()) {
                        hasRecentChanges = true;
                    }
                } else if (ipChanged) {
                    // Kun IP endret
                    const message = `IP: ${previousIP} → ${currentState.ip}`;
                    addToAllLog(`ENDRET: ${message}`, 'change-ip');
                    if (shouldLogChange()) {
                        addToChangesLog(message, 'change-ip');
                    }
                    changeCount++;
                    updateStatus('change-count', changeCount);
                    if (shouldLogChange()) {
                        hasRecentChanges = true;
                    }
                }
                
                currentState.type = getConnectionType();
                await checkForChanges();
                sendStatusReport();
            }, 5000);

            window.addEventListener('online', async () => {
                const prevIP = currentState.ip;
                const newIP = await getIP();
                
                currentState.online = true;
                currentState.ip = newIP;
                updateStatus('online-status', 'Online', true);
                updateStatus('ip-address', newIP, true);
                
                // Én kombinert melding
                const message = `Offline → Online (IP: ${newIP})`;
                addToAllLog(`ENDRET: ${message}`, 'change-status');
                if (shouldLogChange()) {
                    addToChangesLog(message, 'change-status');
                    hasRecentChanges = true;
                }
                changeCount++;
                updateStatus('change-count', changeCount);
            });

            window.addEventListener('offline', () => {
                const prevIP = currentState.ip;
                
                currentState.online = false;
                currentState.ip = 'Offline (ingen IP)';
                updateStatus('online-status', 'Offline', true);
                updateStatus('ip-address', 'Offline (ingen IP)', true);
                
                // Én kombinert melding
                const message = `Online → Offline (var: ${prevIP})`;
                addToAllLog(`ENDRET: ${message}`, 'change-status');
                if (shouldLogChange()) {
                    addToChangesLog(message, 'change-status');
                    hasRecentChanges = true;
                }
                changeCount++;
                updateStatus('change-count', changeCount);
            });

            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                connection.addEventListener('change', () => {
                    addToAllLog(`ENDRET: Nettverksendring oppdaget (${connection.effectiveType})`, 'change-type');
                    addToChangesLog(`Nettverksendring oppdaget (${connection.effectiveType})`, 'change-type');
                    checkForChanges();
                });
            }
        }

        // Start appen med feilhåndtering
        try {
            console.log('Kaller initialize()...');
            initialize().catch(err => {
                console.error('Feil i initialize:', err);
                // Fallback: vis i hvert fall noe
                document.getElementById('all-log-container').innerHTML = '<div class="log-entry change">FEIL: ' + err.message + '</div>';
            });
        } catch (err) {
            console.error('Kritisk feil:', err);
        }
    </script>
</body>
</html>
